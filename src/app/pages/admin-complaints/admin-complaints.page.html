<section class="flex flex-col gap-8">
  <header class="space-y-2">
    <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Admin Console</p>
    <h1 class="text-3xl font-semibold text-white">All complaints</h1>
    <p class="text-sm text-slate-400">Review and update complaint status.</p>
  </header>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h2 class="text-lg font-semibold text-white">Complaints list</h2>
      <div class="flex flex-wrap items-center gap-3">
        <app-complaint-status-filter
          [selected]="statusFilter()"
          (change)="setStatusFilter($event)"
        />
        <button
          type="button"
          class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400 hover:text-slate-200"
          (click)="loadComplaints()"
        >
          Refresh
        </button>
      </div>
    </div>

    <div class="mt-4 space-y-4">
      @if (listLoading()) {
        <p class="text-sm text-slate-400">Loading complaints...</p>
      } @else {
        @if (listError()) {
          <div
            class="rounded-lg border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-sm text-rose-200"
            aria-live="polite"
          >
            {{ listError() }}
          </div>
        } @else {
          @if (complaints().length === 0) {
            <p class="text-sm text-slate-400">No complaints available.</p>
          } @else if (filteredComplaints().length === 0) {
            <p class="text-sm text-slate-400">No complaints found.</p>
          } @else {
            @if (actionError()) {
              <div
                class="rounded-lg border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-sm text-rose-200"
                aria-live="polite"
              >
                {{ actionError() }}
              </div>
            }
            <div class="space-y-3">
              @for (complaint of filteredComplaints(); track complaint.id) {
                <article class="rounded-xl border border-slate-800 bg-slate-950/70 p-4">
                  <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                    <div class="space-y-2">
                      <p class="text-sm text-slate-100">{{ complaint.description }}</p>
                      <div class="flex flex-wrap items-center gap-3 text-xs text-slate-400">
                        <span>{{ complaint.createdAt | date: 'medium' }}</span>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <span
                        class="rounded-full border px-2 py-0.5 text-xs font-semibold"
                        [class]="statusClass(complaint.status)"
                      >
                        {{ complaint.status }}
                      </span>
                      <button
                        type="button"
                        class="rounded-full border border-emerald-400/40 px-3 py-1 text-xs font-semibold text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100 disabled:cursor-not-allowed disabled:opacity-50"
                        [disabled]="isBusy(complaint.id) || complaint.status === 'approved'"
                        (click)="updateStatus(complaint, 'approved')"
                      >
                        Approve
                      </button>
                      <button
                        type="button"
                        class="rounded-full border border-rose-400/40 px-3 py-1 text-xs font-semibold text-rose-200 transition hover:border-rose-300 hover:text-rose-100 disabled:cursor-not-allowed disabled:opacity-50"
                        [disabled]="isBusy(complaint.id) || complaint.status === 'rejected'"
                        (click)="updateStatus(complaint, 'rejected')"
                      >
                        Reject
                      </button>
                      <button
                        type="button"
                        class="flex h-8 w-8 items-center justify-center rounded-full border border-rose-400/40 text-xs font-semibold text-rose-200 transition hover:border-rose-300 hover:text-rose-100 disabled:cursor-not-allowed disabled:opacity-50"
                        [disabled]="isDeleting(complaint.id)"
                        (click)="requestDelete(complaint)"
                        aria-label="Delete complaint"
                        title="Delete complaint"
                      >
                        X
                      </button>
                    </div>
                  </div>
                  <div class="mt-4 space-y-3 border-t border-slate-800 pt-4">
                    <div class="space-y-2">
                      <label
                        class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"
                        [attr.for]="'admin-comment-' + complaint.id"
                        >Admin comment</label
                      >
                      <textarea
                        rows="3"
                        class="w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 outline-none transition focus:border-slate-500"
                        [id]="'admin-comment-' + complaint.id"
                        [value]="commentDraft(complaint.id)"
                        (input)="setCommentDraft(complaint.id, $any($event.target).value)"
                        (keydown)="handleCommentKeydown($event, complaint)"
                        placeholder="Add context for approval or rejection (optional)."
                      ></textarea>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      <button
                        type="button"
                        class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400 transition hover:text-slate-200"
                        (click)="toggleComments(complaint.id)"
                        [attr.aria-expanded]="areCommentsOpen(complaint.id)"
                        [attr.aria-controls]="'complaint-comments-' + complaint.id"
                      >
                        <span
                          class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-slate-700 text-[10px]"
                          aria-hidden="true"
                        >
                          {{ areCommentsOpen(complaint.id) ? 'âˆ’' : '+' }}
                        </span>
                        Comments ({{ commentsCount(complaint) }})
                      </button>
                    </div>
                    @if (areCommentsOpen(complaint.id)) {
                      <div
                        class="space-y-2 rounded-xl border border-slate-800 bg-slate-950/60 p-3"
                        [attr.id]="'complaint-comments-' + complaint.id"
                      >
                        @if (commentsCount(complaint) === 0) {
                          <p class="text-xs text-slate-400">No comments yet.</p>
                        } @else {
                          <div class="space-y-2">
                            @for (
                              comment of complaint.comments ?? [];
                              track comment.id ?? comment.content
                            ) {
                              <div class="rounded-lg border border-slate-800 bg-slate-900/60 p-3">
                                <div
                                  class="flex flex-wrap items-center gap-2 text-[11px] text-slate-400"
                                >
                                  <span>{{ comment.createdAt | date: 'medium' }}</span>
                                </div>
                                <p class="mt-2 text-sm text-slate-100">{{ comment.content }}</p>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                </article>
              }
            </div>
          }
        }
      }
    </div>
  </div>
</section>

<app-confirm-dialog
  [open]="!!pendingDelete()"
  title="Delete complaint"
  message="This action cannot be undone. Do you want to delete this complaint?"
  confirmLabel="Delete"
  cancelLabel="Cancel"
  dialogId="admin-complaint-delete-dialog"
  (confirm)="confirmDelete()"
  (cancel)="cancelDelete()"
/>
